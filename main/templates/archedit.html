<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit-{{.Profile.Name}}</title>

    <script type="text/javascript" src="/assets/vendor/jquery/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/assets/vendor/bootstrap/css/bootstrap.css">

    <link rel="stylesheet" type="text/css" href="/assets/css/archedit.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>
<div class="overall">
    <div class="leftbar">
        <div class="tools">
          <div class = "add-items-text">
            <div >
                Click to add and drag.
            </div>

          </div>
          <div class ="additems bed-items" id = "furniture-options">
            <div id = "budget"> Budget: 
              <div class = "remain-budget"> 10000</div>
            </div>
             <button class = "btns"  onclick="addItemImage(this, '008-table', 500)">
                <img class = "item-img" src="/assets/icons/lineral/008-table.svg" alt="Table.svg">  Table </img>
                <div id = "item1"> $500</div>
            </button>
            <button class = "btns"  onclick="addItemImage(this, '010-carpet', 100)">
                <img class = "item-img"  src="/assets/icons/lineral/010-carpet.svg" alt="Toilet.svg">  Carpet </img>
                <div id = "item2"> $100</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '001-sofa', 1000)">
                <img class = "item-img" src="/assets/icons/lineral/001-sofa.svg" alt="Sofa.svg">  Sofa </img>
                <div id = "item3" > $1000</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '025-bed', 800)">
                <img class = "item-img" src="/assets/icons/lineral/025-bed.svg" alt="Bed.svg">  Bed </img>
                <div id = "item4" > $800</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '011-tv-table', 1500)">
                <img class = "item-img" src="/assets/icons/lineral/011-tv-table.svg" alt="TV.svg">  TV </img>
                 <div id = "item5" > $1500</div>
            </button>
          </div>
          
          <div class ="additems bath-items" id = "furniture-options">
            <div id = "budget"> Budget: 
              <div class = "remain-budget"> 10000</div>
            </div>
             <button class = "btns"  onclick="addItemImage(this, '015-sink.svg', 200)">
                <img class = "item-img" src="/assets/icons/lineral/015-sink.svg" alt="Table.svg">  Sink </img>
                <div id = "item1"> $200</div>
            </button>
            <button class = "btns"  onclick="addItemImage(this, '014-toilet', 400)">
                <img class = "item-img"  src="/assets/icons/lineral/014-toilet.svg" alt="Toilet.svg">  Toilet </img>
                <div id = "item2"> $400</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '017-bath', 800)">
                <img class = "item-img" src="/assets/icons/lineral/017-bath.svg" alt="Sofa.svg">  Bath </img>
                <div id = "item3" > $800</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '013-shower', 500)">
                <img class = "item-img" src="/assets/icons/lineral/013-shower.svg" alt="Bed.svg">  Shower </img>
                <div id = "item4" > $500</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '021-sink-1', 600)">
                <img class = "item-img" src="/assets/icons/lineral/021-sink-1.svg" alt="TV.svg">  Double Sink </img>
                 <div id = "item5" > $600</div>
            </button>
          </div>
          
          <div class ="additems live-items" id = "furniture-options">
            <div id = "budget"> Budget: 
              <div class = "remain-budget"> 10000</div>
            </div>
             <button class = "btns"  onclick="addItemImage(this, '008-table', 500)">
                <img class = "item-img" src="/assets/icons/lineral/008-table.svg" alt="Table.svg">  Table </img>
                <div id = "item1"> $1500</div>
            </button>
            <button class = "btns"  onclick="addItemImage(this, '012-desk-chair', 100)">
                <img class = "item-img"  src="/assets/icons/lineral/012-desk-chair.svg" alt="Toilet.svg"> Desk Chair </img>
                <div id = "item2"> $100</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '001-sofa', 1000)">
                <img class = "item-img" src="/assets/icons/lineral/001-sofa.svg" alt="Sofa.svg">  Sofa </img>
                <div id = "item3" > $1000</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '041-treadmill', 1500)">
                <img class = "item-img" src="/assets/icons/lineral/041-treadmill.svg" alt="Bed.svg"> Treadmill </img>
                <div id = "item4" > $1500</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '033-piano', 5000)">
                <img class = "item-img" src="/assets/icons/lineral/033-piano.svg" alt="TV.svg"> Piano </img>
                 <div id = "item5" > $5000</div>
            </button>
          </div>

          <div class ="additems kitchen-items" id = "furniture-options">
            <div id = "budget"> Budget: 
              <div class = "remain-budget"> 10000</div>
            </div>
             <button class = "btns"  onclick="addItemImage(this, '022-burner', 1200)">
                <img class = "item-img" src="/assets/icons/lineral/022-burner.svg" alt="Table.svg"> Electric Stove </img>
                <div id = "item1"> $1200</div>
            </button>
            <button class = "btns"  onclick="addItemImage(this, '023-burner-1', 1500)">
                <img class = "item-img"  src="/assets/icons/lineral/023-burner-1.svg" alt="Toilet.svg"> Gas Stove </img>
                <div id = "item2"> $1500</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '024-sink-2', 200)">
                <img class = "item-img" src="/assets/icons/lineral/024-sink-2.svg" alt="Sofa.svg"> Kitchen Sink </img>
                <div id = "item3" > $200</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '007-chair', 50)">
                <img class = "item-img" src="/assets/icons/lineral/007-chair.svg" alt="Bed.svg"> Chair </img>
                <div id = "item4" > $50</div>
            </button>
            <button class = "btns" onclick="addItemImage(this, '030-lamp', 20)">
                <img class = "item-img" src="/assets/icons/lineral/030-lamp.svg" alt="TV.svg"> Lamp </img>
                 <div id = "item5" > $20</div>
            </button>
          </div>
           
        </div>

        <div class="textures"></div>
    </div>

    <div class="designBoard">
        <ul>
                <li class="bath"> Bathroom</li>
                <li class="bed"> Bedroom</li>
                <li class="live">Living Room</li>
                <li class="kitchen">Kitchen</li>
<!--             <div class="gear">
                <div class="center"></div>
                <div class="tooth"></div>
                <div class="tooth"></div>
                <div class="tooth"></div>
                <div class="tooth"></div>
            </div> -->
        </ul>
                  <div id="bath" class="tab"></div>

            <div id="bed" class="tab"></div>
            <div id="live" class="tab"></div>
            <div id="kitchen" class="tab"></div>
    </div>

    <div class="chatbox">
      <div class="adjust">
                <div id="setting-text">
                    Item properties:
                </div>
                <input type="range" min="0" max="300" value="100" class="slider" id="scaling">
                <p class="input-text">Scale: <span id="scale"></span> %</p>
                <input type="range" min="-180" max="180" value="0" class="slider" id="rotating">
                <p class="input-text">Rotation: <span id="rotate"></span> deg</p>
                <div id="setting-button">
                    <button class="setting-buttons" id="deselect-button" onclick="deselectItem()">
                        Deselect
                    </button>
                    <button class="setting-buttons" id="delete-button" onclick="deleteItem()">
                        Delete
                    </button>
                </div>
            </div>
<!--         <div class = "adjust">
            <h5> Item properties: </h5>
            Selected item is circled red.
            <p>Zoom: <span id="scale"></span> %</p>
            <input type="range" min="0" max="200" value="100" class="slider" id="scaling">
            <p>Rotation: <span id="rotate"></span> deg</p>
            <input type="range" min="-180" max="180" value="0" class="slider" id="rotating">
            <button onclick="deselectItem()">
                Deselect
            </button>
            <button onclick="deleteItem()">
                Delete
            </button>
        </div> -->
        <div class = "chat">
            Client Info:
            {{.Profile.Name}}
            {{printf "%.2f" .Profile.Budget}}
            {{.Profile.Area}}
            {{.Profile.Location}}
            <hr />
            <textarea id="chatBoxMessage">

            </textarea>
        </div>
    </div>
</div>
</body>

<script>

   var connectionMade = false;
   setInterval(function(){
       if(connectionMade){
           connection.send(JSON.stringify({content:"</Alive>"}));
       }
   },1000)
   var connection = new WebSocket('ws://final160-alexanderpark.codeanyapp.com:2323/commun');
         connection.onopen = function(){
              connectionMade=true;
              connection.send("server");
         }
    connection.onmessage = function(receivedMessage){
             console.log("received antthing")
           let packet = JSON.parse(receivedMessage.data)
           //packet["text"]
        if(packet["content"]==""){
            return
        }
        else{
            $("#chatBoxMessage").val($("#chatBoxMessage").val()+"\n"+(packet["content"]))
        }
           
    }
   connection.onclose = function(){
       console.log("closed")
       connection.close()
       connectionMade=false;
   }
   connection.onerror = function(){
             console.log("failed")
   }

    // Set chatbox style.
    $("#chatBoxMessage").css("width","100%")
    $("#chatBoxMessage").css("height","50%")
    $("#chatBoxMessage").css("resize","none");
    $("#chatBoxMessage").attr("disabled","disabled");
    $("#chatBoxMessage").val("Messages from {{.Profile.Name}}:\n{{.CurrentProject.TextSoFar}}");
    $("#chatBoxMessage").css("background-color","#000")
    $("#chatBoxMessage").css("color","#fff")

    // In case we want "undo" and "redo."
    //item_properties = []
    // Gary's scaling+rotating. See archeditlatest.html for its history.
    var rightclickeditem = null;
    // Add floorplan images as the background
    var currentDiv = "bed";
    var highlight = "#35AEDD";
    var unhightlight = "#542344";
    var hovercolor = "#111";
    var img_dimensions = document.getElementById("bed").clientHeight * 0.9;
  
    var budget = {{printf "%.2f" .Profile.Budget}};
  
    $(".bed").css("background-color", highlight);
    $("#bath").prepend("<img id = 'bath-room' src = '/assets/imgs/floorplans/bathroom-floorplan.svg' width = '"+ img_dimensions +"px' height = '"+ img_dimensions +"px' />");
    $("#bed").prepend("<img id = 'bed-room' src = '/assets/imgs/floorplans/bedroom-floorplan.svg' width = '"+ img_dimensions +"px' height = '"+ img_dimensions +"px' />");
    $("#live").prepend("<img id = 'living-room' src = '/assets/imgs/floorplans/livingroom-floorplan.svg' width = '"+ img_dimensions +"px' height = '"+ img_dimensions +"px'/>");
    $("#kitchen").prepend("<img id = 'kitch-room' src = '/assets/imgs/floorplans/kitchen-floorplan.svg' width = '"+ img_dimensions +"px' height = '"+ img_dimensions +"px'/>");
    $(".designBoard>.tab").css("visibility", "hidden");
    $("#bed").css("visibility", "visible");
    
    loadButtons();
    //set budget
    setBudget(budget);
    var item_dimensions = document.getElementById("furniture-options").clientHeight * 0.10;
    $(".item-img").css("width", item_dimensions + "px");
    $(".item-img").css("height", item_dimensions + "px");
  
    var currentItemsMenu = ".bed-items";
  
    $("ul>li").click(function() {
        $("." + currentDiv).css("background-color", "");
        $(this).css("background-color", highlight);
        $(".designBoard>.tab").css("visibility", "hidden");
        $("#" + this.className).css("visibility", "visible");
        
        currentDiv = this.className;
      showRoomItems(this.className);
    });

    // Create elements in div designBoard
    function addItemImage(elem, itemName, val) {
        // TODO: rename this function to 'addItem'
        var img = new Image(80,80);
        img.style.position = "absolute";
        img.src = "/assets/icons/lineral/" + itemName + ".svg";
        // Right-click to select itself for scale & rotate.
        img.oncontextmenu = function(e) { 
            e.preventDefault();
            selectItem(this);
        }
        img.value = val;
        //console.log("image val: " + img.value);
        document.getElementById(currentDiv).appendChild(img);
        makeDraggable(img);
        selectItem(img);
        deductBudget(val);
    }
    // Largely borrowed from w3schools.com/howto/howto_js_draggable.asp
    function makeDraggable(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;
        elmnt.onpointerdown = dragMouseDown;
        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onpointerup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
            document.onpointermove = elementDrag;
            
            selectItem(elmnt);
        }
        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            

            //pos3 = bounds(pos3, 0, document.getElementById(currentDiv).clientWidth);
            pos4 = bounds(pos4, screen.height/100 * 6 , document.getElementById(currentDiv).clientHeight);
            pos3 = bounds(pos3, (screen.width - document.getElementById(currentDiv).clientWidth)/2 , (screen.width - document.getElementById(currentDiv).clientWidth)/2 +  document.getElementById(currentDiv).clientWidth);
            // Gary: set the element's new position:
            //console.log(bounds(elmnt.offsetTop - pos2, 0, bounds(document.getElementById(currentDiv).clientHeight)));
            elmnt.style.top = bounds(elmnt.offsetTop - pos2, 0, document.getElementById(currentDiv).clientHeight - elmnt.clientHeight) + "px";
            elmnt.style.left = bounds(elmnt.offsetLeft - pos1, 0, document.getElementById(currentDiv).clientWidth - elmnt.clientWidth) + "px";

        }
        function bounds (number, lowerlimit, upperlimit) {
            if (number > upperlimit) {
                return upperlimit;
            } else if (number < lowerlimit) {
                return lowerlimit;
            } else {
                return number;
            }
        }
        function closeDragElement() {
            /* stop moving when mouse button is released:*/
            document.onmouseup = null;
            document.onpointerend = null;
            document.onmousemove = null;
            document.onpointermove = null;
            transmit()
        }
    }
    function randomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
    // Gary's scaling+rotating. See archeditlatest.html for its history
    var slider = document.getElementById("scaling");
    var output = document.getElementById("scale");
    output.innerHTML = slider.value;
    var originaldimensen = 80;
    slider.oninput = function() {
        output.innerHTML = this.value;
        rightclickeditem.width = originaldimensen * (this.value/100);
        rightclickeditem.height = originaldimensen * (this.value/100);
    }
    
    var slider1 = document.getElementById("rotating");
    var output1 = document.getElementById("rotate");
    output1.innerHTML = slider1.value;
    slider1.oninput = function () {
        rightclickeditem.style.transform = "rotate(" +this.value + "deg)";
        output1.innerHTML = this.value;
    }
    
    function selectItem(elem) {
        // Search the global var, rightclickeditem, for its usage.
        // Clear previous selection.
        if (rightclickeditem != elem) {
            deselectItem();
        }
        rightclickeditem = elem;
        rightclickeditem.style.outline = "5px solid red";
    }
  
    function deselectItem() {
        // Reset everything.
        resetRightBar();
        if (rightclickeditem != null) {
            // Cleanup after deselecting an item.
            rightclickeditem.style.outline = "none";
        }
    }
    
    // Reset the value displayed in the ItemProperties sidebar.
    function resetRightBar() {
        document.getElementById("scale").innerHTML = "100";
        document.getElementById("scaling").value = "100"; // Default to 100%
        document.getElementById("rotate").innerHTML = "0";
        document.getElementById("rotating").value = "0"
    }

    // Deselect when tab is switched.
    $(".bath, .bed, .live, .kitchen").click(function() {
        deselectItem();
    });
    
    function deleteItem() {
        if (rightclickeditem != null) {
            rightclickeditem.parentNode.removeChild(rightclickeditem);
        }
        budget = budget + rightclickeditem.value;
        setBudget(budget);
    }

    var globalLoad = 0;
    var message = ""
    function toImage(elem){

        return (html2canvas(elem).then((canvas) => {

            console.log("then")
            //console.log(""+canvas.toDataURL("image/png", 1.0).replace("image/png", "image/octet-stream"))
            message+=canvas.toDataURL("image/png", 1.0).replace("image/png", "image/octet-stream")+"</Delim>";
        }).catch(err => {
            console.error(err);
        }));
    }

    function transmit() {

         var bedPNG = document.getElementById("bed");
         var bathPNG = document.getElementById("bath");
         var livePNG = document.getElementById("live");
         var kitchenPNG = document.getElementById("kitchen");

         var strings = "";
        console.log("enter")
        toImage(bedPNG)
        toImage(bathPNG)
        toImage(livePNG)
        toImage(kitchenPNG)

         //strings+=toImage(bathPNG)+",";
         //strings+=toImage(livePNG)+",";
         //strings+=toImage(kitchenPNG)

        var packet = {content:message}
        connection.send(packet)
        message=""

    }
    function deductBudget(val) {
      budget = budget - val;
      setBudget(budget);
    }
    function setBudget(b) {
      $(".remain-budget").text(b);
    }
  
    function loadButtons() {
      $(".bath-items").css("visibility", "hidden");
      $(".live-items").css("visibility", "hidden");
      $(".kitchen-items").css("visibility", "hidden");
      
    }
    
    function showRoomItems(x) {
      $(currentItemsMenu).css("visibility", "hidden");
      currentItemsMenu = "." + x + "-items";
      $(currentItemsMenu).css("visibility","visible");
      setBudget(b);

      
    }
</script>

</html>
